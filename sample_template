global
  log 127.0.0.1 local0
  log-tag haproxy
  daemon
  quiet
  stats socket /var/run/haproxy.sock
  stats timeout 2m
  maxconn 1024
resolvers default
  nameserver coreos-gateway1 192.168.62.217:53
  nameserver coreos-gateway2 192.168.62.218:53
  resolve_retries 3
defaults
  timeout connect 5000ms
  timeout client 10000ms
  timeout server 10000ms
  log global
  mode tcp
  balance roundrobin
  option dontlognull
  option redispatch
{{range $service, $ports := $.Services}}{{if $ports.NodePort}}frontend {{$service.ServiceName}}_{{$service.PortName}}
  default_backend {{$service.ServiceName}}_{{$service.PortName}}
  bind *:{{$ports.Port}}
  maxconn 2000
backend {{$service.ServiceName}}_{{$service.PortName}}
  {{range $node, $host := $.Nodes}}server {{$node.NodeName}} {{$host.InternalIP}}:{{$ports.NodePort}}
  {{end}}
{{else}}frontend {{$service.ServiceName}}_{{$service.PortName}}
  default_backend {{$service.ServiceName}}_{{$service.PortName}}
  bind *:{{$ports.Port}}
  maxconn 2000
backend {{$service.ServiceName}}_{{$service.PortName}}
  {{range $node, $host := $.Nodes}}server {{$node.NodeName}} {{$host.InternalIP}}:{{$ports.Port}}
  {{end}}
{{end}}{{end}}
